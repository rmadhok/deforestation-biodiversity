---
title: 'Infrastructure Development, Deforestation, and Biodiversity in India'
output: 
  html_document:
    number_sections: true
author: 'Raahil Madhok'
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r "setup", include=FALSE}
require("knitr")
opts_knit$set(root.dir = '/Users/rmadhok/Dropbox (Personal)')
```


**What's new here**

This document shows a series of visualizations from the eBird and deforestation data in order to decipher data trends and patterns that will guide the econometric analysis.

```{r,include=F,warning=FALSE,message=FALSE}
# Packages
require(tidyverse)
require(sf)
require(viridis)
require(ggpubr)
require(raster)
require(rasterVis)
#--------------------------------------------------------------------------

# Load Basemap
india_districts <- st_read(paste("IndiaPowerPlant/data/maps/india-district", sep=""), 
                           'SDE_DATA_IN_F7DSTRBND_2011', stringsAsFactors = F)
india_districts <- india_districts[india_districts$ID>1,]
```

# Deforestation and Bird-watching Activity
The infrastructure data consists only of projects requiring deforestation. Thus, these projects are located in the 20% of India's land area that is forested. The map below shows 2018 forest cover at 250m resolution from the NASA MODIS Vegetation Continuous Field (VCF) data product. Values indicate percentage tree cover in a cell.

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
# Read forest cover from external drive
forest_cover <- raster(paste('/Volumes/Backup Plus/research/def_biodiv/forest_cover/mosaic/MOD44B.006_Percent_Tree_Cover_doy2018065_aid0001.tif'))

# Crop to India extent
forest_cover <- crop(forest_cover, india_districts)
forest_cover <- mask(forest_cover, india_districts)
forest_cover[forest_cover > 100] <- NA

# Plot
levelplot(forest_cover, 
          margin=F,
          xlab=NULL,
          ylab=NULL,
          colorkey=list(
            space='bottom',
            axis.line=list(col='black')),
          scales=list(draw=F),
          col.regions=viridis,
          at=seq(0,100),
          par.settings=list(
            axis.line=list(col='transparent')))
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
# Read Data
defn <- st_read(paste('def_biodiv/data/csv/', sep=''), 
                         'fc_dist_ym', stringsAsFactors = F)

# Prepare 2015 and 2018 cross-section
defn_year <- defn %>% 
  mutate(district_forest_cum_km2 = as.numeric(district_forest_cum_km2)) %>%
  arrange(c_code_2011, year_month) %>%
  group_by(c_code_2011, year) %>%
  summarize(district_forest_cum_km2 = last(district_forest_cum_km2)) %>%
  filter(year == 2015 | year == 2018) %>%
  rename(c_code_11 = c_code_2011)
  
india_dist_def <- left_join(india_districts, defn_year, by="c_code_11")
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
# Plot 2015/2018 cross-section
ggplot(india_dist_def, aes(fill = district_forest_cum_km2)) +
 geom_sf(alpha = 0.8, colour = 'white', size = 0.3) +
 scale_fill_viridis(name = "Cumulative Deforestation (km2)",
                    direction = -1,
                    guide = guide_colourbar(
                      direction = "horizontal",
                      barheight = unit(2, units = "mm"),
                      barwidth = unit(50, units = "mm"),
                      draw.ulim = F,
                      title.position = 'top',
                      title.hjust = 0.5,
                      label.hjust = 0.5)) +
 coord_sf(datum = NA) +
 theme(line = element_blank(),
       axis.text = element_blank(),
       axis.title = element_blank(),
       panel.background = element_blank(),
       legend.position = 'bottom',
       legend.title = element_text(size = 10),
       legend.text = element_text(size = 8)) +
 facet_wrap(~year, drop=T)
ggsave(paste('def_biodiv/docs/tex_doc/fig/deforestation.png', sep=''))
```

## Change in Deforestation between First and Last Period
This map shows the change in cumulative deforestation (for infrastructure) between 2015 and 2018. There is ample time-series and cross-sectional variation in central, northern, and part of eastern India. These regions correspond to the regions with highest forest cover. 

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
# Change in Deforestation
defn_change <- spread(defn_year, year, district_forest_cum_km2)
defn_change$theta_district_forest_cum_km2 <- defn_change$`2018`-defn_change$`2015`
defn_change <- defn_change[,c(1,4)]
india_dist_def <- left_join(india_districts, defn_change, by="c_code_11")
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
# Plot Change in Deforestation
def_plot <- ggplot(india_dist_def, aes(fill = theta_district_forest_cum_km2)) +
  geom_sf(alpha = 0.8, colour = 'white', size = 0.3) +
  scale_fill_viridis(name = "Cumulative Deforestation (km2)",
                     direction = -1,
                     guide = guide_colourbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       title.hjust = 0.5,
                       label.hjust = 0.5)) +
  coord_sf(datum = NA) +
  theme(line = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.background = element_blank(),
        legend.position = 'bottom',
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 8))
def_plot
ggsave(paste('def_biodiv/docs/tex_doc/fig/theta_deforestation.png', sep=''))
```

## Birding Activity in Deforestation Districts
This map compares the deforestation map above with spatial variation in bird-watching activity. Panel B shows the difference between the number of trips in a district and the mean number of trips in the sample for districts that experienced deforestation during the study period. Grey means the district did not experience deforestation. For the purpose of illustration, birding activity is truncated at the 95th percentile to adjust for outlier bird-watchers who skew the color distribution (a handful of users have over 11,000 trips).  

From panel B, there is ample variation in bird-watching activity in deforestation districts. High intensity bird-watching districts (number of trips greater than the mean) are present in all quadrants of India. 

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
# Read Data
ebird <- st_read(paste('def_biodiv/data/csv', sep=''),
                   'ebird_all', stringsAsFactors = F)

# Truncate at 95th percentile
ebird_trunc <- ebird %>%
  mutate(n_trips = as.numeric(n_trips)) %>%
  filter(n_trips < quantile(n_trips, 0.95))

# Summarize trips per district
trips <- ebird_trunc %>%
  group_by(c_code_2011) %>%
  summarize(n_trips = sum(n_trips, na.rm=T)) %>%
  rename(c_code_11 = c_code_2011)
trips <- trips %>% mutate(sd_trips = (n_trips-mean(n_trips))/sd(n_trips))

india_dist_def <- left_join(india_dist_def, trips, by="c_code_11")
india_dist_def$sd_trips[india_dist_def$theta_district_forest_cum_km2==0] <- NA
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
trip_plot <- ggplot() +
  geom_sf(data=st_union(india_districts$geom), fill=NA, color='black') +
  geom_sf(data=india_dist_def, aes(fill=sd_trips), 
          alpha = 0.8, colour = 'white', size = 0.3) +
  scale_fill_viridis(name = "Z-score",
                     direction = -1,
                     na.value='white',
                     guide = guide_colourbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       title.hjust = 0.5,
                       label.hjust = 0.5)) +
  coord_sf(datum = NA) +
  theme(line = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.background = element_blank(),
        legend.position = 'bottom',
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 8))
ggsave(paste('def_biodiv/docs/tex_doc/fig/n_trips_district.png', sep=''))
```


```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
# Combine number of trips and deforestation
ggarrange(def_plot, trip_plot, align='h', labels=c("A", "B"))
ggsave(paste('def_biodiv/docs/tex_doc/fig/def_n_trips.png', sep=''))
```

## Spatial Coverage of Birding Activity in Deforestation Districts
The map in panel B shows the spatial coverage of bird-watching activity. This is measured by gridding the district map into 8km x 8km cells and computing the percentage of cells with at least one bird sighting. This tells us whether bird-watching is concentrated within a district or not. It is useful for capturing access, since infrastructure projects may open up access to pristine parts of the forest. 

Panels A and B show that districts with infrastructure projects also have nearly full coverage of birding activity. This implies that no matter where the project is constructed, there is likely bird-watching activity nearby. 

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
coverage <- st_read(paste('def_biodiv/data/csv/', sep=''), 
                'coverage_dist_grid_8km', stringsAsFactors = F)
coverage <- coverage %>%
  mutate(coverage_all = as.numeric(coverage_all)*100) %>%
  rename(c_code_11 = c_code_2011)

india_dist_def <- left_join(india_districts, coverage, by="c_code_11")
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
sp_coverage <- ggplot(india_dist_def, aes(fill = coverage_all)) +
  geom_sf(alpha = 0.8, colour = 'white', size = 0.3) +
  scale_fill_viridis(name = "% of district grid cells in which birds spotted",
                     direction = -1,
                     guide = guide_colourbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       title.hjust = 0.5,
                       label.hjust = 0.5)) +
  coord_sf(datum = NA) +
  theme(line = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.background = element_blank(),
        legend.position = 'bottom',
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 8))
ggsave(paste('def_biodiv/docs/tex_doc/fig/coverage.png', sep=''))
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
# Combine number of trips and deforestation
ggarrange(def_plot, sp_coverage, align='h', labels=c("A", "B"))
ggsave(paste('def_biodiv/docs/tex_doc/fig/def_coverage.png', sep=''))
rm(list=c('defn', 'defn_year', 'defn_change', 'coverage', 'trip_plot', 'def_plot', 'forest_cover'))
```

# eBird Data
The final eBird data for this analysis includes 7 million bird sightings from 3100 users and 500,000 trips. There is rich variation in the timing and location of these trips, so it is important to identify predictable trends in birding activity (number of trips) and species diversity that may bias the coefficients in the empirical analysis.

## Birding Activity: Number of Trips

### CDF of Number of Trips
The district-monthly data aggregates species diversity across bird-watching trips in each district-time period. The CDF below shows the CDF of the number of trips making up each observation. 50% of observations are made up of less than 10 trips and 10% are made up of more than 50. In the empirical analysis, I use weighted least squares so that more precisely measured observations (made up of many trips) are given more influence over coefficient determination than less precisely measured points. 

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
ggplot(ebird_trunc, aes(n_trips)) +
  stat_ecdf(geom='step') +
  ylab('Cumulative Probability') +
  xlab('Number of Trips') +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme(panel.grid.minor = element_blank(), 
        axis.line = element_blank(), 
        axis.ticks = element_blank())
ggsave(paste('def_biodiv/docs/tex_doc/fig/cdf_n_trips.png', sep=''))
```

### Number of Trips by Month
Bird-watching is a seasonal activity and the number of trips likely fluctuates with the weather. For example, monsoon months may see less activity because of rains and humidity. It is important to understand the seasonal dynamics of bird-watching to ensure that the coefficient estimates are not picking up seasonal trends in the dependent and independent variables. 

The plot confirms a seasonal trend in bird-watching. The number of trips are highest in winter months--with nearly 100,000 trips taken in January--before dropping to nearly 25,000 during the monsoon. It is likely that this trend also partially explains variation in species richness since there are more opportunities to see rare birds in the winter months. 

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
# Summarize trips/month
ebird$month <- as.numeric(substr(ebird$YEARMONTH, 6,7))
ebird_trips_month <- ebird %>%
  group_by(month) %>%
  mutate(n_trips = as.numeric(n_trips)) %>%
  summarize(n_trips = sum(n_trips, na.rm=T))

months <- c('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec')
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
n_trips_month_plot <- ggplot(ebird_trips_month, aes(x=month, y=n_trips)) +
  geom_bar(stat="identity", width=0.5) +
  ylab('Number of Trips') +
  scale_x_continuous(breaks=1:12, labels=months) +
  theme(panel.grid.minor = element_blank(), 
        axis.line = element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks = element_blank())
n_trips_month_plot
ggsave(paste('def_biodiv/docs/tex_doc/fig/n_trips_month.png', sep=''))
```

## Seasonality of Unique Species

### Unique Species Across Months of Year
The plot below shows the monthly distribution of the number of unique species for each year in the data. There is a bimodal trend for all years with peaks in the winter months and a trough in the summer. The trend is consistent with bird migration patterns. More species are observed in winter months when migratory birds from colder climates stop over in India. However, the trend may also be explained by the monthly trend in the number of trips.

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
# Read
n_species_ym <- st_read(paste('def_biodiv/data/csv/', sep=''), 
                    'n_species_ym', stringsAsFactors = F)

# Number of species per year-month
n_species_ym <- n_species_ym %>%
  mutate(Year=year, n_species=as.numeric(n_species)) %>%
  filter(Year %in% c('2015', '2016', '2017','2018'))
n_species_ym$month <- as.numeric(substr(n_species_ym$YEARMONTH, 6,7))
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
sp_ym <- ggplot(n_species_ym, aes(x=month, y=n_species, group=Year)) +
  geom_line(aes(color=Year)) +
  geom_point(aes(color=Year)) +
  scale_x_continuous(breaks=1:12, labels=months) +
  ylab('Species Richness') +
  scale_color_viridis_d() + 
  theme(panel.grid.minor = element_blank(), 
        axis.line = element_blank(), 
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle=45),
        axis.ticks = element_blank(),
        legend.position=c(0.56,0.92), 
        legend.direction="horizontal", 
        legend.background = element_rect(fill='transparent'))
sp_ym
ggsave(paste('def_biodiv/docs/tex_doc/fig/n_species_ym.png', sep=''))
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
# Read
n_species_yr <- st_read(paste('def_biodiv/data/csv/', sep=''), 
                    'n_species_yr', stringsAsFactors = F)

# Number of species per year
n_species_yr <- n_species_yr %>%
  mutate(YEAR=as.numeric(YEAR), n_species=as.numeric(n_species)) %>%
  filter(YEAR<2019)
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
sp_yr <- ggplot(n_species_yr, aes(x=YEAR, y=n_species)) +
  geom_line() +
  geom_point() +
  ylab('Species Richness') +
  theme(panel.grid.minor = element_blank(), 
        axis.line = element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks = element_blank())
ggsave(paste('def_biodiv/docs/tex_doc/fig/n_species_yr.png', sep=''))
```

### Unique Species Across Time
One characteristic of the monthly species richness distribution is that, for any given month, species richness is higher across years. This could be because of increases in overall bird migration over time (check news?). The plot below compares annual and monthly species richness. The number of unique species is consistently higher across years, and this is also true across months-of-year.  

Another explanation is that increases in species diversity over time is driven by an increase in the popularity of the app. 

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=9}
# Combine year and year-month species plots
ggarrange(sp_yr, sp_ym + rremove('y.title'), align='h', labels=c("A", "B"))
ggsave(paste('def_biodiv/docs/tex_doc/fig/n_species_yr_ym.png', sep=''))
```

### Trends in species diversity and bird-watching activity
The plot below compares seasonality of species diversity with seasonality in eBird activity. If the bars in panel B were constant, then the trend in panel A would be more likely due to bird migration patterns. However, the similar, shared distribution across months implies that variation in birding activity is partially responsible for the seasonal trend in species richness.   

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=9}
# Combine year and year-month species plots
ggarrange(sp_ym, n_trips_month_plot, nrow=2, align='h', labels=c("A", "B"))
ggsave(paste('def_biodiv/docs/tex_doc/fig/n_species_yr_ym.png', sep=''))
```

# Trip Level Data
The trip-level data includes individual identifiers, so I can track an individual's trips across time and space. The plots below show the distribution of *per-user* characteristics. Across the sample period, most users take around 100 trips across 15 time periods and travel through 6 states and 10 districts. This provides a huge amount of variation to exploit in the trip-level analysis with individual fixed effects. 

```{r,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
ebird_trip <- st_read(paste('def_biodiv/data/csv/', sep=''), 
                'ebird_triplevel', stringsAsFactors = F)

ebird_trip$state_code_2011 <- substr(ebird_trip$c_code_2011,1,3)

# User-level Trip Characteristics
ebird_user <- ebird_trip %>%
  group_by(OBSERVER.ID) %>%
  summarize("No. of Trips" = as.numeric(n_distinct(SAMPLING.EVENT.IDENTIFIER)),
            "No. of States" = as.numeric(n_distinct(state_code_2011)),
            "No. of Districts" = as.numeric(n_distinct(c_code_2011)),
            "No. of Year-months" = as.numeric(n_distinct(YEARMONTH))) %>%
  filter(`No. of Trips` < quantile(`No. of Trips`, 0.95)) %>%
  gather(user_characteristic, number, 2:5) %>%
  arrange(OBSERVER.ID, user_characteristic)
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,fig.height=6,fig.width=8}
# Plot Distribution of user characteristics
ggplot(ebird_user, aes(ebird_user$number)) +
  geom_histogram(aes(y=..density..), binwidth=1) +
  facet_wrap(~user_characteristic, scales='free') +
  ylab('Density') +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme(panel.grid.minor = element_blank(), 
        axis.title.x = element_blank(),
        axis.line = element_blank(), 
        axis.ticks = element_blank())
ggsave(paste('def_biodiv/docs/tex_doc/fig/user_charac_hist.png', sep=''))
```